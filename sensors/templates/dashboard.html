<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temperature Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .temperature-toggle {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 25px;
            padding: 5px;
            display: inline-flex;
            margin-top: 10px;
        }
        
        .temp-option {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 20px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .temp-option.active {
            background: rgba(255,255,255,0.3);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .control-group {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 10px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .control-group select, .control-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .small-chart {
            height: 250px;
        }
        
        .large-chart {
            height: 400px;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .status.online {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.offline {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .insight-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .insight-title {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
        }
        
        .insight-icon {
            margin-right: 8px;
            font-size: 1.2em;
        }
        
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .metric-row:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: #666;
        }
        
        .metric-value {
            font-weight: bold;
            color: #333;
        }
        
        .trend-indicator {
            display: inline-flex;
            align-items: center;
            font-size: 0.9em;
            margin-left: 8px;
        }
        
        .trend-up { color: #e74c3c; }
        .trend-down { color: #3498db; }
        .trend-stable { color: #95a5a6; }
        
        .alert-card {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);
            color: white;
            margin-bottom: 20px;
        }
        
        .info-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
    </style>
</head>
<body>
    </style>
</head>
<body>
    <div class="header">
        <h1>üå°Ô∏è Temperature Monitoring Dashboard</h1>
        <p>Real-time temperature data with historical analysis</p>
        <div class="temperature-toggle">
            <button class="temp-option active" onclick="setTemperatureUnit('c')">¬∞C</button>
            <button class="temp-option" onclick="setTemperatureUnit('f')">¬∞F</button>
        </div>
        <div id="status" class="status offline">Connecting...</div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="current-temp">--</div>
            <div class="stat-label">Current Temperature (<span id="unit-1">¬∞C</span>)</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="min-temp">--</div>
            <div class="stat-label">24h Min (<span id="unit-2">¬∞C</span>)</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="max-temp">--</div>
            <div class="stat-label">24h Max (<span id="unit-3">¬∞C</span>)</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="avg-temp">--</div>
            <div class="stat-label">24h Average (<span id="unit-4">¬∞C</span>)</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="total-readings">--</div>
            <div class="stat-label">Total Readings</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="last-update">--</div>
            <div class="stat-label">Last Update</div>
        </div>
    </div>

    <!-- Insights Section -->
    <div class="insights-grid">
        <div class="insight-card" id="temperature-insights">
            <div class="insight-title">
                <span class="insight-icon">üå°Ô∏è</span>
                Temperature Analysis
            </div>
            <div id="temp-analysis-content">
                <div class="metric-row">
                    <span class="metric-label">Loading analysis...</span>
                    <span class="metric-value">--</span>
                </div>
            </div>
        </div>
        
        <div class="insight-card" id="trend-insights">
            <div class="insight-title">
                <span class="insight-icon">üìà</span>
                Recent Trends
            </div>
            <div id="trend-analysis-content">
                <div class="metric-row">
                    <span class="metric-label">Loading trends...</span>
                    <span class="metric-value">--</span>
                </div>
            </div>
        </div>
        
        <div class="insight-card" id="efficiency-insights">
            <div class="insight-title">
                <span class="insight-icon">‚ö°</span>
                System Performance
            </div>
            <div id="efficiency-analysis-content">
                <div class="metric-row">
                    <span class="metric-label">Data collection rate</span>
                    <span class="metric-value" id="collection-rate">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Sensor reliability</span>
                    <span class="metric-value" id="sensor-reliability">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Average interval</span>
                    <span class="metric-value" id="avg-interval">--</span>
                </div>
            </div>
        </div>
        
        <div class="insight-card" id="environment-insights">
            <div class="insight-title">
                <span class="insight-icon">üè†</span>
                Environment Insights
            </div>
            <div id="environment-analysis-content">
                <div class="metric-row">
                    <span class="metric-label">Loading environment data...</span>
                    <span class="metric-value">--</span>
                </div>
            </div>
        </div>
    </div>

    <div class="controls">
        <div class="control-group">
            <label for="time-range">Time Range:</label>
            <select id="time-range">
                <option value="1">Last Hour</option>
                <option value="6">Last 6 Hours</option>
                <option value="24" selected>Last 24 Hours</option>
                <option value="72">Last 3 Days</option>
                <option value="168">Last Week</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="room-filter">Room:</label>
            <select id="room-filter">
                <option value="">All Rooms</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="comparison-days">Comparison Days:</label>
            <select id="comparison-days">
                <option value="3">Last 3 Days</option>
                <option value="7" selected>Last 7 Days</option>
                <option value="14">Last 14 Days</option>
                <option value="30">Last 30 Days</option>
            </select>
        </div>
    </div>

    <!-- Trend Comparison Charts -->
    <div class="chart-grid">
        <div class="chart-container">
            <div class="chart-title">Last Hour vs Previous Day</div>
            <div id="trend-1h-chart" class="small-chart"></div>
        </div>
        <div class="chart-container">
            <div class="chart-title">Last 4 Hours vs Previous Day</div>
            <div id="trend-4h-chart" class="small-chart"></div>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-title">Real-time Temperature</div>
        <div id="realtime-chart" class="large-chart"></div>
    </div>

    <div class="chart-container">
        <div class="chart-title">Hourly Temperature Comparison</div>
        <div id="hourly-chart" class="large-chart"></div>
    </div>

    <div class="chart-container">
        <div class="chart-title">Daily Temperature Summary</div>
        <div id="daily-chart" class="large-chart"></div>
    </div>

    <script>
        class TemperatureDashboard {
            constructor() {
                this.updateInterval = 1000; // 1 second for real-time updates
                this.currentUnit = 'c';
                this.chartLayouts = new Map(); // Store chart layouts to preserve zoom
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.startAutoUpdate();
                this.updateAll();
            }

            setupEventListeners() {
                document.getElementById('time-range').addEventListener('change', () => this.updateRealtimeChart());
                document.getElementById('room-filter').addEventListener('change', () => this.updateRealtimeChart());
                document.getElementById('comparison-days').addEventListener('change', () => this.updateHourlyChart());
            }
            
            preserveZoom(chartId) {
                const chartDiv = document.getElementById(chartId);
                if (chartDiv && chartDiv.layout) {
                    const layout = JSON.parse(JSON.stringify(chartDiv.layout));
                    this.chartLayouts.set(chartId, {
                        'xaxis.range': layout.xaxis?.range,
                        'yaxis.range': layout.yaxis?.range
                    });
                }
            }
            
            restoreZoom(chartId, layout) {
                const savedLayout = this.chartLayouts.get(chartId);
                if (savedLayout) {
                    if (savedLayout['xaxis.range']) {
                        layout.xaxis = layout.xaxis || {};
                        layout.xaxis.range = savedLayout['xaxis.range'];
                        layout.xaxis.autorange = false;
                    }
                    if (savedLayout['yaxis.range']) {
                        layout.yaxis = layout.yaxis || {};
                        layout.yaxis.range = savedLayout['yaxis.range'];
                        layout.yaxis.autorange = false;
                    }
                }
                return layout;
            }

            async fetchStats() {
                try {
                    const response = await fetch(`/api/stats?unit=${this.currentUnit}`);
                    const data = await response.json();
                    
                    if (data.error) {
                        console.error('Stats error:', data.error);
                        return null;
                    }
                    
                    const unitSymbol = this.currentUnit === 'f' ? '¬∞F' : '¬∞C';
                    
                    // Update stats display
                    document.getElementById('current-temp').textContent = data.current_temp || '--';
                    document.getElementById('min-temp').textContent = data.min_24h || '--';
                    document.getElementById('max-temp').textContent = data.max_24h || '--';
                    document.getElementById('avg-temp').textContent = data.avg_24h || '--';
                    document.getElementById('total-readings').textContent = data.total_readings || '--';
                    document.getElementById('last-update').textContent = data.last_reading ? new Date(data.last_reading).toLocaleTimeString() : '--';
                    
                    // Update unit labels
                    document.querySelectorAll('[id^="unit-"]').forEach(el => {
                        el.textContent = unitSymbol;
                    });
                    
                    // Update room filter
                    const roomFilter = document.getElementById('room-filter');
                    const currentValue = roomFilter.value;
                    roomFilter.innerHTML = '<option value="">All Rooms</option>';
                    
                    if (data.rooms && data.rooms.length > 0) {
                        data.rooms.forEach(room => {
                            const option = document.createElement('option');
                            option.value = room;
                            option.textContent = room;
                            if (room === currentValue) option.selected = true;
                            roomFilter.appendChild(option);
                        });
                    }
                    
                    // Update status
                    const status = document.getElementById('status');
                    status.textContent = `Online - Last reading: ${data.last_reading ? new Date(data.last_reading).toLocaleTimeString() : 'Never'}`;
                    status.className = 'status online';
                    
                    return data;
                } catch (error) {
                    console.error('Error fetching stats:', error);
                    document.getElementById('status').textContent = 'Offline - Connection error';
                    document.getElementById('status').className = 'status offline';
                    return null;
                }
            }

            async updateRealtimeChart() {
                try {
                    const hours = document.getElementById('time-range').value;
                    const room = document.getElementById('room-filter').value;
                    const url = `/api/realtime?hours=${hours}&unit=${this.currentUnit}${room ? `&room=${room}` : ''}`;
                    
                    this.preserveZoom('realtime-chart');
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    const unitSymbol = this.currentUnit === 'f' ? '¬∞F' : '¬∞C';
                    
                    const trace = {
                        x: data.timestamps,
                        y: data.temperatures,
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { color: '#667eea', width: 2 },
                        marker: { color: '#667eea', size: 4 },
                        name: 'Temperature'
                    };
                    
                    let layout = {
                        xaxis: { title: 'Time' },
                        yaxis: { title: `Temperature (${unitSymbol})` },
                        margin: { t: 30, r: 30, b: 50, l: 50 },
                        showlegend: false
                    };
                    
                    layout = this.restoreZoom('realtime-chart', layout);
                    
                    Plotly.newPlot('realtime-chart', [trace], layout, { responsive: true });
                } catch (error) {
                    console.error('Error updating realtime chart:', error);
                }
            }

            async updateTrendCharts() {
                try {
                    const unitSymbol = this.currentUnit === 'f' ? '¬∞F' : '¬∞C';
                    
                    // 1 hour trend
                    const response1h = await fetch(`/api/trend_comparison?hours=1&unit=${this.currentUnit}`);
                    const data1h = await response1h.json();
                    
                    if (data1h.current && data1h.previous) {
                        const traces1h = [
                            {
                                x: data1h.current.minutes,
                                y: data1h.current.temperatures,
                                type: 'scatter',
                                mode: 'lines+markers',
                                name: data1h.current.label,
                                line: { color: '#667eea', width: 2 },
                                marker: { size: 3 }
                            },
                            {
                                x: data1h.previous.minutes,
                                y: data1h.previous.temperatures,
                                type: 'scatter',
                                mode: 'lines+markers',
                                name: data1h.previous.label,
                                line: { color: '#fa709a', width: 2, dash: 'dash' },
                                marker: { size: 3 }
                            }
                        ];
                        
                        const layout1h = {
                            xaxis: { title: 'Minutes' },
                            yaxis: { title: `Temperature (${unitSymbol})` },
                            margin: { t: 30, r: 30, b: 50, l: 50 },
                            showlegend: true,
                            legend: { x: 0, y: 1, bgcolor: 'rgba(255,255,255,0.8)' }
                        };
                        
                        Plotly.newPlot('trend-1h-chart', traces1h, layout1h, { responsive: true });
                    }
                    
                    // 4 hour trend
                    const response4h = await fetch(`/api/trend_comparison?hours=4&unit=${this.currentUnit}`);
                    const data4h = await response4h.json();
                    
                    if (data4h.current && data4h.previous) {
                        const traces4h = [
                            {
                                x: data4h.current.minutes,
                                y: data4h.current.temperatures,
                                type: 'scatter',
                                mode: 'lines+markers',
                                name: data4h.current.label,
                                line: { color: '#667eea', width: 2 },
                                marker: { size: 3 }
                            },
                            {
                                x: data4h.previous.minutes,
                                y: data4h.previous.temperatures,
                                type: 'scatter',
                                mode: 'lines+markers',
                                name: data4h.previous.label,
                                line: { color: '#fa709a', width: 2, dash: 'dash' },
                                marker: { size: 3 }
                            }
                        ];
                        
                        const layout4h = {
                            xaxis: { title: 'Minutes' },
                            yaxis: { title: `Temperature (${unitSymbol})` },
                            margin: { t: 30, r: 30, b: 50, l: 50 },
                            showlegend: true,
                            legend: { x: 0, y: 1, bgcolor: 'rgba(255,255,255,0.8)' }
                        };
                        
                        Plotly.newPlot('trend-4h-chart', traces4h, layout4h, { responsive: true });
                    }
                } catch (error) {
                    console.error('Error updating trend charts:', error);
                }
            }
            
            async updateInsights() {
                try {
                    const response = await fetch(`/api/insights?unit=${this.currentUnit}`);
                    const data = await response.json();
                    
                    const unitSymbol = this.currentUnit === 'f' ? '¬∞F' : '¬∞C';
                    
                    // Temperature Analysis
                    const tempAnalysis = document.getElementById('temp-analysis-content');
                    if (data.temperature_analysis) {
                        const ta = data.temperature_analysis;
                        tempAnalysis.innerHTML = `
                            <div class="metric-row">
                                <span class="metric-label">Current vs 24h avg</span>
                                <span class="metric-value">${ta.current_vs_avg > 0 ? '+' : ''}${ta.current_vs_avg}${unitSymbol}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Temperature stability</span>
                                <span class="metric-value">${ta.stability}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">24h range</span>
                                <span class="metric-value">${ta.range_24h}${unitSymbol} (${ta.range_assessment})</span>
                            </div>
                        `;
                    }
                    
                    // Trend Analysis
                    const trendAnalysis = document.getElementById('trend-analysis-content');
                    if (data.trend_analysis) {
                        const tr = data.trend_analysis;
                        const trendIcon = tr.hourly_trend === 'Rising' ? 'üìà' : tr.hourly_trend === 'Falling' ? 'üìâ' : '‚û°Ô∏è';
                        trendAnalysis.innerHTML = `
                            <div class="metric-row">
                                <span class="metric-label">Recent trend</span>
                                <span class="metric-value">${trendIcon} ${tr.hourly_trend}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Hourly change</span>
                                <span class="metric-value">${tr.hourly_change > 0 ? '+' : ''}${tr.hourly_change}${unitSymbol}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">vs Yesterday</span>
                                <span class="metric-value">${tr.vs_yesterday}</span>
                            </div>
                        `;
                    }
                    
                    // System Performance
                    if (data.system_performance) {
                        const sp = data.system_performance;
                        document.getElementById('collection-rate').textContent = sp.collection_rate;
                        document.getElementById('sensor-reliability').textContent = sp.reliability;
                        document.getElementById('avg-interval').textContent = sp.avg_interval;
                    }
                    
                    // Environment Insights
                    const envAnalysis = document.getElementById('environment-analysis-content');
                    if (data.environment_insights) {
                        const ei = data.environment_insights;
                        envAnalysis.innerHTML = `
                            <div class="metric-row">
                                <span class="metric-label">Warmest time</span>
                                <span class="metric-value">üåÖ ${ei.warmest_hour}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Coolest time</span>
                                <span class="metric-value">üåô ${ei.coolest_hour}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Daily variation</span>
                                <span class="metric-value">${ei.daily_variation}${unitSymbol} (${ei.pattern_strength})</span>
                            </div>
                        `;
                    }
                    
                    // Handle alerts
                    this.displayAlerts(data.alerts);
                    
                } catch (error) {
                    console.error('Error updating insights:', error);
                }
            }
            
            displayAlerts(alerts) {
                // Remove existing alert cards
                document.querySelectorAll('.alert-card').forEach(card => card.remove());
                
                if (alerts && alerts.length > 0) {
                    const header = document.querySelector('.header');
                    alerts.forEach(alert => {
                        const alertCard = document.createElement('div');
                        alertCard.className = 'insight-card alert-card';
                        alertCard.innerHTML = `
                            <div class="insight-title">
                                <span class="insight-icon">‚ö†Ô∏è</span>
                                Alert: ${alert.type.replace('_', ' ').toUpperCase()}
                            </div>
                            <div style="margin-top: 10px;">
                                ${alert.message}
                            </div>
                        `;
                        header.insertAdjacentElement('afterend', alertCard);
                    });
                }
            }

            async updateHourlyChart() {
                try {
                    const days = document.getElementById('comparison-days').value;
                    const response = await fetch(`/api/hourly_comparison?days=${days}&unit=${this.currentUnit}`);
                    const data = await response.json();
                    
                    const unitSymbol = this.currentUnit === 'f' ? '¬∞F' : '¬∞C';
                    
                    this.preserveZoom('hourly-chart');
                    
                    const traces = [];
                    const colors = ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a', '#ffcc02', '#ff6b6b'];
                    let colorIndex = 0;
                    
                    for (const [date, hourlyData] of Object.entries(data)) {
                        const hours = Array.from({length: 24}, (_, i) => i);
                        const temps = hours.map(hour => hourlyData[hour] || null);
                        
                        traces.push({
                            x: hours,
                            y: temps,
                            type: 'scatter',
                            mode: 'lines+markers',
                            name: date,
                            line: { color: colors[colorIndex % colors.length], width: 2 },
                            marker: { size: 4 }
                        });
                        colorIndex++;
                    }
                    
                    let layout = {
                        xaxis: { title: 'Hour of Day', tickmode: 'linear', dtick: 2 },
                        yaxis: { title: `Temperature (${unitSymbol})` },
                        margin: { t: 30, r: 30, b: 50, l: 50 },
                        showlegend: true,
                        legend: { orientation: 'h', y: -0.2 }
                    };
                    
                    layout = this.restoreZoom('hourly-chart', layout);
                    
                    Plotly.newPlot('hourly-chart', traces, layout, { responsive: true });
                } catch (error) {
                    console.error('Error updating hourly chart:', error);
                }
            }

            async updateDailyChart() {
                try {
                    const response = await fetch(`/api/daily_summary?days=30&unit=${this.currentUnit}`);
                    const data = await response.json();
                    
                    const unitSymbol = this.currentUnit === 'f' ? '¬∞F' : '¬∞C';
                    
                    this.preserveZoom('daily-chart');
                    
                    if (!Array.isArray(data) || data.length === 0) {
                        console.log('No daily summary data available');
                        return;
                    }
                    
                    const dates = data.map(d => d.date);
                    const mins = data.map(d => d.min);
                    const maxs = data.map(d => d.max);
                    const avgs = data.map(d => d.avg);
                    
                    const traces = [
                        {
                            x: dates,
                            y: mins,
                            type: 'scatter',
                            mode: 'lines+markers',
                            name: 'Min',
                            line: { color: '#4facfe', width: 2 },
                            marker: { size: 4 }
                        },
                        {
                            x: dates,
                            y: avgs,
                            type: 'scatter',
                            mode: 'lines+markers',
                            name: 'Average',
                            line: { color: '#667eea', width: 2 },
                            marker: { size: 4 }
                        },
                        {
                            x: dates,
                            y: maxs,
                            type: 'scatter',
                            mode: 'lines+markers',
                            name: 'Max',
                            line: { color: '#fa709a', width: 2 },
                            marker: { size: 4 }
                        }
                    ];
                    
                    let layout = {
                        xaxis: { title: 'Date' },
                        yaxis: { title: `Temperature (${unitSymbol})` },
                        margin: { t: 30, r: 30, b: 50, l: 50 },
                        showlegend: true,
                        legend: { orientation: 'h', y: -0.2 }
                    };
                    
                    layout = this.restoreZoom('daily-chart', layout);
                    
                    Plotly.newPlot('daily-chart', traces, layout, { responsive: true });
                } catch (error) {
                    console.error('Error updating daily chart:', error);
                }
            }

            async updateAll() {
                await this.fetchStats();
                await this.updateRealtimeChart();
                await this.updateHourlyChart();
                await this.updateDailyChart();
                await this.updateTrendCharts();
                await this.updateInsights();
            }

            startAutoUpdate() {
                // Fast updates for real-time data and insights
                setInterval(() => {
                    this.fetchStats();
                    this.updateRealtimeChart();
                    this.updateTrendCharts();
                    this.updateInsights();
                }, this.updateInterval);
                
                // Slower updates for historical charts
                setInterval(() => {
                    this.updateHourlyChart();
                    this.updateDailyChart();
                }, this.updateInterval * 30); // Every 30 seconds
            }
        }

        // Global functions for temperature unit switching
        function setTemperatureUnit(unit) {
            const dashboard = window.temperatureDashboard;
            if (dashboard) {
                dashboard.currentUnit = unit;
                
                // Update button states
                document.querySelectorAll('.temp-option').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[onclick="setTemperatureUnit('${unit}')"]`).classList.add('active');
                
                // Update all charts and stats
                dashboard.updateAll();
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.temperatureDashboard = new TemperatureDashboard();
        });
    </script>
</body>
</html>
